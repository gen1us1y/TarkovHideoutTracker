<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Shelter Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –º–æ–¥—É–ª–∏ –∏–ª–∏ –∫–≤–µ—Å—Ç—ã -->
        <div class="left">
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–ª–µ–≤–∞ -->
            <div class="left-tabs">
                <button type="button" class="tab-btn active" data-left-tab="modules">–ú–æ–¥—É–ª–∏</button>
                <button type="button" class="tab-btn" data-left-tab="quests">–ö–≤–µ—Å—Ç—ã</button>
            </div>

            <!-- –ú–æ–¥—É–ª–∏ -->
            <div id="left-modules" class="left-content active">
                <h2>–ú–æ–¥—É–ª–∏</h2>
                {% for mod in modules %}
                <div class="module">
                    <strong>{{ mod.name|e }}</strong>
                    <select onchange="updateLevel('{{ mod.name|e }}', this.value)" 
                            data-old-value="{{ mod.current_level }}">
                        {% for lvl in range(0, mod.max_level + 1) %}
                            <option value="{{ lvl }}" {% if lvl == mod.current_level %}selected{% endif %}>
                                –£—Ä–æ–≤–µ–Ω—å {{ lvl }} / {{ mod.max_level }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>

            <!-- –ö–≤–µ—Å—Ç—ã -->
            <div id="left-quests" class="left-content">
                <h2>–ö–≤–µ—Å—Ç—ã</h2>
                {% for trader in traders %}
                <div class="trader" data-trader-id="{{ trader.id }}">
                    <div class="trader-header">
                        <label>
                            <input type="checkbox"
                                   onchange="toggleTraderHidden({{ trader.id }}, this.checked)"
                                   {% if trader.is_hidden %}checked{% endif %}>
                            <strong>{{ trader.name|e }}</strong>
                        </label>
                    </div>
                    <div class="quests" style="{% if trader.is_hidden %}display:none;{% endif %}">
                        {% for quest in trader.quests %}
                        <div class="quest">
                            <label>
                                <input type="checkbox"
                                       onchange="toggleQuest({{ quest.id }}, this.checked)"
                                       {% if quest.is_completed %}checked{% endif %}>
                                {{ quest.name|e }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –µ–¥–∏–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
        <div class="right">
            <div class="tabs">
                <button type="button" class="tab-btn active" data-tab="remaining">–û—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å</button>
                <button type="button" class="tab-btn" data-tab="next-level">–ù–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
            </div>

            <!-- –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å -->
            <div id="tab-remaining" class="tab-content active">
                <h2>–û—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å</h2>
                <table id="items-table">
                    <thead><tr>
                        <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–ù—É–∂–Ω–æ</th>
                        <th>–ï—Å—Ç—å ‚úèÔ∏è</th>
                        <th>–û—Å—Ç–∞–ª–æ—Å—å</th>
                    </tr></thead>
                    <tbody id="items-tbody">
                        {% for item in items %}
                        <tr data-item-name="{{ item.item_name|e }}">
                            <td><img src="{{ url_for('static', filename='img/' + item.item_image) }}" alt="{{ item.item_name|e }}" width="32"></td>
                            <td>{{ item.item_name|e }}</td>
                            <td class="need-col">{{ item.need }}</td>
                            <td>
                                <input type="number" min="0" value="{{ item.have }}"
                                       data-item-name="{{ item.item_name|e }}"
                                       style="width:60px; text-align:right;">
                            </td>
                            <td class="left-col" style="font-weight: bold; color: {{ 'green' if item.left == 0 else 'red' }}">
                                {{ item.left }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not items %}
                <p>‚úÖ –í—Å—ë —Å–æ–±—Ä–∞–Ω–æ!</p>
                {% endif %}
            </div>

            <!-- –ù–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å -->
            <div id="tab-next-level" class="tab-content">
                <h2>–ù–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</h2>
                <div id="next-level-loader" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                <table id="next-level-table" style="display:none;">
                    <thead><tr>
                        <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–ù—É–∂–Ω–æ</th>
                        <th>–ï—Å—Ç—å ‚úèÔ∏è</th>
                        <th>–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç</th>
                    </tr></thead>
                    <tbody id="next-level-tbody"></tbody>
                </table>
                <p id="next-level-empty" style="display:none;">‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –Ω–∞ –º–∞–∫—Å. —É—Ä–æ–≤–Ω–µ –∏–ª–∏ —Ä–µ—Å—É—Ä—Å—ã —Å–æ–±—Ä–∞–Ω—ã!</p>
            </div>
        </div>
    </div>
    <script>
        // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ) ===
        function updateRowUI(row, newHave) {
            const needCell = row.querySelector('.need-col');
            const haveInput = row.querySelector('input[type="number"]');
            const leftCell = row.querySelector('.left-col');

            if (!needCell || !haveInput || !leftCell) return;

            const need = parseInt(needCell.textContent) || 0;
            const have = parseInt(newHave) || 0;
            const left = Math.max(0, need - have);

            haveInput.value = have;
            leftCell.textContent = left;
            leftCell.style.color = left === 0 ? 'green' : 'red';
        }

        // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–ï—Å—Ç—å" (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ) ===
        function updateHave(itemName, value) {
            if (!itemName || typeof itemName !== 'string') {
                console.warn('–ü—Ä–æ–ø—É—â–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –ø—É—Å—Ç–æ–µ –∏–º—è –ø—Ä–µ–¥–º–µ—Ç–∞');
                return;
            }

            fetch('/update_have', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item: itemName, have: value })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'));
                    return;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—Ç—Ä–æ–∫–∏ —Å —ç—Ç–∏–º –ø—Ä–µ–¥–º–µ—Ç–æ–º (–º–æ–¥—É–ª–∏ + –∫–≤–µ—Å—Ç—ã)
                const rows = document.querySelectorAll(`tr[data-item-name="${CSS.escape(itemName)}"]`);
                rows.forEach(row => updateRowUI(row, value));
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
            });
        }

        // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –º–æ–¥—É–ª—è ===
        function updateLevel(module, newLevel) {
            fetch('/update_level', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ module: module, level: parseInt(newLevel) })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('‚ùå ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å'));
                    // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º select
                    const select = document.querySelector(`select[onchange*="'${module}'"]`);
                    if (select && select.dataset.oldValue) {
                        select.value = select.dataset.oldValue;
                    }
                    return;
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É (–æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å)
                fetchItemsTable();
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }

        // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–º–æ–¥—É–ª–∏ / –∫–≤–µ—Å—Ç—ã) ===
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-left-tab]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.leftTab;
                    const content = document.getElementById('left-' + tabId);
                    if (!content) {
                        console.error('–õ–µ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', tabId);
                        return;
                    }

                    document.querySelectorAll('[data-left-tab]').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.left-content').forEach(c => c.classList.remove('active'));

                    btn.classList.add('active');
                    content.classList.add('active');

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å
                    const rightActive = document.querySelector('.tab-btn.active')?.dataset.tab || 'remaining';
                    if (tabId === 'modules') {
                        if (rightActive === 'remaining') {
                            fetchItemsTable();
                        } else if (rightActive === 'next-level') {
                            loadNextLevelItems();
                        }
                    } else if (tabId === 'quests') {
                        loadQuestsTab();
                    }
                });
            });

            // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–æ—Å—Ç–∞–ª–æ—Å—å / —Å–ª–µ–¥. —É—Ä–æ–≤–µ–Ω—å) ===
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    const content = document.getElementById('tab-' + tabId);
                    if (!content) {
                        console.error('–ü—Ä–∞–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', tabId);
                        return;
                    }

                    document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    btn.classList.add('active');
                    content.classList.add('active');

                    const leftActive = document.querySelector('[data-left-tab].active')?.dataset.leftTab;
                    if (leftActive === 'modules') {
                        if (tabId === 'remaining') {
                            fetchItemsTable();
                        } else if (tabId === 'next-level') {
                            loadNextLevelItems();
                        }
                    }
                });
            });

            // === –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ change –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ ===
            document.addEventListener('change', function(e) {
                const input = e.target;
                if (input.tagName === 'INPUT' && input.type === 'number') {
                    const itemName = input.dataset.itemName;
                    if (itemName) {
                        const value = parseInt(input.value) || 0;
                        if (value < 0) input.value = 0;
                        updateHave(itemName, value);
                    }
                }
            });

            // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü ===
            function fetchItemsTable() {
                fetch('/items_table')
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('items-tbody');
                        if (!tbody) return;

                        let html = '';
                        data.items.forEach(item => {
                            const color = item.left === 0 ? 'green' : 'red';
                            html += `
                                <tr data-item-name="${CSS.escape(item.item_name)}">
                                    <td><img src="/static/img/${item.item_image}" alt="${item.item_name}" width="32"></td>
                                    <td>${item.item_name}</td>
                                    <td class="need-col">${item.need}</td>
                                    <td>
                                        <input type="number" min="0" value="${item.have}"
                                               data-item-name="${item.item_name}"
                                               style="width:60px; text-align:right;">
                                    </td>
                                    <td class="left-col" style="font-weight:bold;color:${color}">${item.left}</td>
                                </tr>`;
                        });
                        tbody.innerHTML = html;
                    })
                    .catch(err => {
                        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É:', err);
                        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤');
                    });
            }

            function loadNextLevelItems() {
                const loader = document.getElementById('next-level-loader');
                const table = document.getElementById('next-level-table');
                const emptyMsg = document.getElementById('next-level-empty');
                const tbody = document.getElementById('next-level-tbody');

                if (loader) loader.style.display = 'block';
                if (table) table.style.display = 'none';
                if (emptyMsg) emptyMsg.style.display = 'none';

                fetch('/next_level_items')
                    .then(response => response.json())
                    .then(data => {
                        if (loader) loader.style.display = 'none';
                        const items = data.items || [];

                        if (items.length === 0) {
                            if (emptyMsg) emptyMsg.style.display = 'block';
                            if (table) table.style.display = 'none';
                            return;
                        }

                        let html = '';
                        items.forEach(item => {
                            const color = item.left === 0 ? 'green' : 'red';
                            const hintLines = item.entries.map(e => 
                                `${e.module} (—É—Ä. ${e.level}) ‚Äî √ó${e.quantity}`
                            ).join('<br>‚Äì ');

                            html += `
                                <tr data-item-name="${item.item_name}">
                                    <td><img src="/static/img/${item.item_image}" width="32"></td>
                                    <td>
                                        ${item.item_name}
                                        <details style="margin-top:4px; font-size:0.85em; color:#666;">
                                            <summary style="cursor:pointer; list-style:square;">üîπ –û—Ç–∫—É–¥–∞ –Ω—É–∂–Ω–æ</summary>
                                            ‚Äì ${hintLines}
                                        </details>
                                    </td>
                                    <td class="need-col">${item.need}</td>
                                    <td>
                                        <input type="number" min="0" value="${item.have}"
                                               data-item-name="${item.item_name}"
                                               style="width:60px; text-align:right;">
                                    </td>
                                    <td class="left-col" style="font-weight:bold;color:${color}">${item.left}</td>
                                </tr>`;
                        });

                        if (tbody) {
                            tbody.innerHTML = html;
                            if (table) table.style.display = 'table';
                        }
                    })
                    .catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ next-level:', err);
                        if (loader) loader.style.display = 'none';
                        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è');
                    });
            }

            function loadQuestsTab() {
                fetch('/quests_data')
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('items-tbody');
                        if (!tbody) return;

                        let html = '';
                        data.items.forEach(item => {
                            const color = item.left === 0 ? 'green' : 'red';
                            html += `
                                <tr data-item-name="${CSS.escape(item.item_name)}">
                                    <td><img src="/static/img/${item.item_image}" width="32"></td>
                                    <td>${item.item_name}</td>
                                    <td class="need-col">${item.need}</td>
                                    <td>
                                        <input type="number" min="0" value="${item.have}"
                                               data-item-name="${item.item_name}"
                                               style="width:60px; text-align:right;">
                                    </td>
                                    <td class="left-col" style="font-weight:bold;color:${color}">${item.left}</td>
                                </tr>`;
                        });
                        tbody.innerHTML = html || '<tr><td colspan="5">‚úÖ –í—Å—ë —Å–æ–±—Ä–∞–Ω–æ!</td></tr>';
                    });
            }

            // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–≤–µ—Å—Ç–æ–≤ (–≤—ã–Ω–µ—Å–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏) ===
            window.toggleQuest = function(questId, completed) {
                fetch('/toggle_quest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quest_id: questId, completed: completed })
                })
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'));
                        const cb = document.querySelector(`input[onchange*="toggleQuest(${questId}"]`);
                        if (cb) cb.checked = !completed;
                        return;
                    }
                    loadQuestsTab();
                });
            };

            window.toggleTraderHidden = function(traderId, hidden) {
                fetch('/toggle_trader_hidden', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trader_id: traderId, hidden: hidden })
                })
                .then(() => {
                    const traderEl = document.querySelector(`.trader[data-trader-id="${traderId}"]`);
                    if (traderEl) {
                        const questsEl = traderEl.querySelector('.quests');
                        if (questsEl) questsEl.style.display = hidden ? 'none' : 'block';
                    }
                    loadQuestsTab();
                });
            };
        });
    </script>
</body>
</html>