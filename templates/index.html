<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Shelter Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="left">
            <h2>–ú–æ–¥—É–ª–∏</h2>
            {% for mod in modules %}
            <div class="module">
                <strong>{{ mod.name }}</strong>
                <select onchange="updateLevel('{{ mod.name|e }}', this.value)">
                    {% for lvl in range(0, mod.max_level + 1) %}
                        <option value="{{ lvl }}" {% if lvl == mod.current_level %}selected{% endif %}>
                            –£—Ä–æ–≤–µ–Ω—å {{ lvl }} / {{ mod.max_level }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
        </div>

        <div class="right">
            <div class="tabs">
                <button type="button" class="tab-btn active" data-tab="remaining">–û—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å</button>
                <button type="button" class="tab-btn" data-tab="next-level">–ù–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
            </div>
        
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤–∫–ª–∞–¥–æ–∫ -->
            <div id="tab-remaining" class="tab-content active">
                <h2>–û—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å</h2>
                {% if items %}
                <table id="items-table">
                    <thead><tr>
                        <th></th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–ù—É–∂–Ω–æ</th>
                        <th>–ï—Å—Ç—å ‚úèÔ∏è</th>
                        <th>–û—Å—Ç–∞–ª–æ—Å—å</th>
                    </tr></thead>
                    <tbody id="items-tbody">
                        {% for item in items %}
                        <tr data-item-name="{{ item.item_name|e }}">
                            <td><img src="{{ url_for('static', filename='img/' + item.item_image) }}" alt="{{ item.item_name|e }}" width="48"></td>
                            <td>{{ item.item_name|e }}</td>
                            <td class="need-col">{{ item.need }}</td>
                            <td>
                                <input type="number" min="0" value="{{ item.have }}"
                                       data-item-name="{{ item.item_name|e }}"
                                       style="width:60px; text-align:right;">
                            </td>
                            <td class="left-col" style="font-weight: bold; color: {{ 'green' if item.left == 0 else 'red' }}">
                                {{ item.left }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>‚úÖ –í—Å—ë —Å–æ–±—Ä–∞–Ω–æ!</p>
                {% endif %}
            </div>
        
            <div id="tab-next-level" class="tab-content">
                <h2>–ù–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</h2>
                <div id="next-level-loader" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                <table id="next-level-table" style="display:none;">
                    <thead><tr>
                        <th></th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–ù—É–∂–Ω–æ</th>
                        <th>–ï—Å—Ç—å ‚úèÔ∏è</th>
                        <th>–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç</th>
                    </tr></thead>
                    <tbody id="next-level-tbody"></tbody>
                </table>
                <p id="next-level-empty" style="display:none;">‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –Ω–∞ –º–∞–∫—Å. —É—Ä–æ–≤–Ω–µ –∏–ª–∏ —Ä–µ—Å—É—Ä—Å—ã —Å–æ–±—Ä–∞–Ω—ã!</p>
            </div>
        </div>

    <script>
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–ï—Å—Ç—å"
        function updateHave(itemName, value) {
            if (!itemName || typeof itemName !== 'string') {
                console.warn('–ü—Ä–æ–ø—É—â–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø—Ä–µ–¥–º–µ—Ç–∞', itemName);
                return;
            }

            fetch('/update_have', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item: itemName, have: value })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'));
                    return;
                }

                // –ù–∞—Ö–æ–¥–∏–º –í–°–ï —Å—Ç—Ä–æ–∫–∏ —Å —ç—Ç–∏–º item_name (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –æ–±–µ–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö!)
                const rows = document.querySelectorAll(`tr[data-item-name="${CSS.escape(itemName)}"]`);
                rows.forEach(row => updateRowUI(row, value));
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
            });
        }

        function updateRowUI(row, newHave) {
            const needCell = row.querySelector('.need-col');
            const haveInput = row.querySelector('input[type="number"]');
            const leftCell = row.querySelector('.left-col');

            if (!needCell || !haveInput || !leftCell) return;

            const need = parseInt(needCell.textContent) || 0;
            const have = parseInt(newHave) || 0;
            const left = Math.max(0, need - have);

            haveInput.value = have;
            leftCell.textContent = left;
            leftCell.style.color = left === 0 ? 'green' : 'red';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –º–æ–¥—É–ª—è
        function updateLevel(module, newLevel) {
            fetch('/update_level', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ module: module, level: parseInt(newLevel) })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('‚ùå ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å'));
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —É—Ä–æ–≤–µ–Ω—å –≤ —Å–µ–ª–µ–∫—Ç
                    const select = document.querySelector(`select[onchange*="'${module}'"]`);
                    if (select) {
                        select.value = select.dataset.oldValue || 0;
                    }
                    return;
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                fetchItemsTable();
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }

        // –ó–∞–ø—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (—á–µ—Ä–µ–∑ JSON!)
        function fetchItemsTable() {
            fetch('/items_table')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('items-tbody');
                    if (!tbody) return;

                    let html = '';
                    data.items.forEach(item => {
                        const color = item.left === 0 ? 'green' : 'red';
                        const escapedName = item.item_name.replace(/"/g, '&quot;');
                        html += `
                            <tr data-item-name="${CSS.escape(item.item_name)}">
                                <td><img src="/static/img/${item.item_image}" alt="${item.item_name}" width="48"></td>
                                <td>${item.item_name}</td>
                                <td class="need-col">${item.need}</td>
                                <td>
                                    <input type="number" min="0" value="${item.have}"
                                           data-item-name="${CSS.escape(item.item_name)}"
                                           style="width:60px; text-align:right;">
                                </td>
                                <td class="left-col" style="font-weight:bold;color:${color}">${item.left}</td>
                            </tr>`;
                    });
                    tbody.innerHTML = html;
                })
                .catch(err => {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É:', err);
                    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤');
                });
        }
        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è input
        document.addEventListener('change', function(e) {
            const input = e.target;
            if (input.tagName === 'INPUT' && input.type === 'number') {
                const itemName = input.dataset.itemName;
                if (itemName) {
                    const value = parseInt(input.value) || 0;
                    if (value < 0) input.value = 0;
                    updateHave(itemName, value);
                }
            }
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        document.querySelectorAll('select').forEach(select => {
            select.dataset.oldValue = select.value;
            select.addEventListener('focus', function() {
                this.dataset.oldValue = this.value;
            });
        });

                // === –í–ö–õ–ê–î–ö–ò ===
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å—ë
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω–æ–µ
                btn.classList.add('active');
                document.getElementById('tab-' + tabId).classList.add('active');
                
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º "next-level" ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                if (tabId === 'next-level') {
                    loadNextLevelItems();
                }
            });
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
        function loadNextLevelItems() {
        const loader = document.getElementById('next-level-loader');
        const table = document.getElementById('next-level-table');
        const emptyMsg = document.getElementById('next-level-empty');
        const tbody = document.getElementById('next-level-tbody');

        loader.style.display = 'block';
        table.style.display = 'none';
        emptyMsg.style.display = 'none';

        fetch('/next_level_items')
            .then(response => response.json())
            .then(data => {
                loader.style.display = 'none';
                const items = data.items || [];
                
                if (items.length === 0) {
                    emptyMsg.style.display = 'block';
                    return;
                }

                let html = '';
                items.forEach(item => {
                    const color = item.left === 0 ? 'green' : 'red';
                    const escapedName = CSS.escape(item.item_name);

                    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É: "–¥–ª—è –ú–æ–¥—É–ª—å (—É—Ä. X), –ú–æ–¥—É–ª—å2 (—É—Ä. Y)"
                    let hintLines = item.entries.map(e => 
                        `${e.module} (—É—Ä. ${e.level}) ‚Äî √ó${e.quantity}`
                    ).join('<br>‚Äì ');

                    html += `
                        <tr data-item-name="${item.item_name}">
                            <td><img src="/static/img/${item.item_image}" alt="${item.item_name}" width="32"></td>
                            <td>
                                ${item.item_name}
                                <details style="margin-top:4px; font-size:0.85em; color:#666;">
                                    <summary style="cursor:pointer; list-style:square;">üîπ –û—Ç–∫—É–¥–∞ –Ω—É–∂–Ω–æ</summary>
                                    ‚Äì ${hintLines}
                                </details>
                            </td>
                            <td class="need-col">${item.need}</td>
                            <td>
                                <input type="number" min="0" value="${item.have}"
                                    data-item-name="${item.item_name}"
                                    style="width:60px; text-align:right;">
                            </td>
                            <td class="left-col" style="font-weight:bold;color:${color}">${item.left}</td>
                        </tr>`;
                });
                tbody.innerHTML = html;
                table.style.display = 'table';
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ next-level:', err);
                loader.style.display = 'none';
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è');
            });
    }

        // –û–±–Ω–æ–≤–∏–º fetchItemsTable, —á—Ç–æ–±—ã —Å–∫—Ä—ã–≤–∞—Ç—å next-level –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ "–æ—Å—Ç–∞–ª–æ—Å—å"
        function fetchItemsTable() {
            fetch('/items_table')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('items-tbody');
                    if (!tbody) return;

                    let html = '';
                    data.items.forEach(item => {
                        const color = item.left === 0 ? 'green' : 'red';
                        const escapedName = CSS.escape(item.item_name);
                        html += `
                            <tr data-item-name="${escapedName}">
                                <td><img src="/static/img/${item.item_image}" alt="${item.item_name}" width="32"></td>
                                <td>${item.item_name}</td>
                                <td class="need-col">${item.need}</td>
                                <td>
                                    <input type="number" min="0" value="${item.have}"
                                        data-item-name="${escapedName}"
                                        style="width:60px; text-align:right;">
                                </td>
                                <td class="left-col" style="font-weight:bold;color:${color}">${item.left}</td>
                            </tr>`;
                    });
                    tbody.innerHTML = html;
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–æ—Å—Ç–∞–ª–æ—Å—å", –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç–∞ "next-level"
                    if (document.querySelector('.tab-btn[data-tab="next-level"]').classList.contains('active')) {
                        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å, –Ω–æ –ª–æ–≥–∏—á–Ω–æ ‚Äî –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–æ–¥—É–ª—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É
                        document.querySelector('.tab-btn[data-tab="remaining"]').click();
                    }
                })
                .catch(err => {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É:', err);
                    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤');
                });
        }
    </script>
</body>
</html>